# Парсер для загрузки товаров с сайта магазина сантехники SanMarketParser
Программа для загрузки товаров с сайта Интернет магазина сантехники с учётом структуры групп товаров сайта источника.

Загруженные данные используются для формирования файла импорта товаров для CMS 1C-Bitrix.

## Особенности сайта источника
В связи с тем, что поставщик не предоставляет нормального файла обмена данными о товарах, загрузка товаров осуществляется путём разбора каталога и страниц карточек товаров на сайте поставщика.

Алгоритм загрузки страниц сайта источника пришлось сделать однопоточным. Кроме того, предусмотреть возможность нескольких попыток повторной загрузки в случае неудачи. Отводится 25 попыток с паузой в 15 секунд в случае неудачи.
Дело в том, что многопоточная загрузка приводила к быстрому падению сайта в 503 ошибку.

Причины могут быть разные:
* Ограничение производительности хостинга.
* Выключенное кэширование.
* Просто баги при разработке каталога товаров или самого сайта.

Помимо нестабильной работы, многие ссылки из каталога товаров связаны с множественными 301 перенаправлениями. Причём таких «перенаправлений» в цепочке в отдельных ситуациях встречалось до 3-х штук.

Как следствие, первичная загрузка всего каталога на момент первого релиза составляла более 10 часов на 75Мб канале.

Загрузка изображений для каждого товара осуществляется в один поток по той же причине, что и страницы. Несмотря на то, что статичные ресурсы должны отдаваться без каких-либо затруднений в несколько потоков, нагрузка в 10-15 потоков при загрузке изображений так же приводила к переходу сервера в 503 ошибку.

## Особенности импорта товаров на сайт
Импорт товаров в 1С-Битрикс через CSV файлы накладывает ряд ограничений:
* В текстах описаний не должен содержаться символ разделителя полей. В текущем конкретном случае – это символ «;».
* В текстах полей не допускаются символы переноса строки (\n) и перевода каретки (\r), которые загружаются с сайта источника при очистке текстов от тэгов.
* В описании не допускается использование HTML тэгов. Описание должно загружаться в формате Plain Text.
* Файл обмена должен быть в кодировке сайта. В данном примере – UTF-8.
* Текст файла должен быть очищен от BOM символов.
